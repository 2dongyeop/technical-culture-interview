## 트랜잭션 관리가 어려운 분산 환경에서 일관성을 보장하기 위한 방법은 무엇인가요?

MSA나 분산 시스템에서는 **단일 데이터베이스 트랜잭션(ACID)을 유지하기 어려움**.

따라서, **분산 트랜잭션 대신 다양한 보상(Compensation) 및 일관성 유지 전략**을 활용해야 함.

<br/>

1. **트랜잭션 일관성 모델**

분산 환경에서는 **강한 일관성(Strong Consistency) 대신 최종적 일관성(Eventual Consistency)** 을 보장하는 방식이 일반적.

**트랜잭션 모델 비교**

| 트랜잭션 모델  | 특징                                                        | 적용 사례                   |
|----------|-----------------------------------------------------------|-------------------------|
| **ACID** | 강한 일관성 보장 (Atomicity, Consistency, Isolation, Durability) | 단일 DB 트랜잭션 (Monolithic) |
| **BASE** | 최종적 일관성(Eventual Consistency) 보장                          | MSA, 분산 시스템, NoSQL      |

<br/>

1. **분산 트랜잭션 관리 방법**

> **2PC (Two-Phase Commit) – 강한 일관성**
>

- **분산 트랜잭션을 ACID하게 관리하는 방식**
- **1단계 (Prepare)**: 모든 서비스가 트랜잭션을 준비하고 승인
- **2단계 (Commit)**: 모든 서비스가 commit, 실패 시 rollback
    - **장점:** 강한 일관성 유지
    - **단점:** 성능 저하, 교착 상태 가능
- **사용 사례:** 금융 서비스, 은행 거래 (XA 트랜잭션)

<br/>

> **SAGA 패턴 – 최종적 일관성**
>

- 분산 환경에서 **보상 트랜잭션(Compensation Transaction)** 을 활용하여 트랜잭션 보장
- **Choreography (이벤트 기반)** vs. **Orchestration (중앙 조정)**
    - **장점:** 성능 우수, 서비스 간 느슨한 결합
    - **단점:** 구현 복잡성 증가, 보상 로직 필요
    - **사용 사례:** 주문-결제-배송 시스템
- **예시: Orchestration 기반 SAGA (Spring Boot + Kafka)**

<br/>

> **Outbox Pattern & CDC (Change Data Capture)**
>

- 트랜잭션 내에서 **이벤트를 Outbox 테이블에 저장하고, 이를 비동기 처리**
- DB 변경을 Kafka, Debezium으로 감지하여 이벤트 전달
    - **장점:** 강한 일관성 유지, 확장성 우수
    - **단점:** CDC 구성 필요
- **사용 사례:** 주문 생성 시 메시지 큐(Kafka)로 이벤트 전송

<br/>

> **Idempotency (멱등성) 적용**
>

- 중복 요청 발생 시 **동일한 결과를 보장**하는 기법
- **Redis, DB에서 중복 요청 방지 키(Idempotency Key) 활용**
- **예시: Redis로 중복 요청 방지**

<br/>

> **결론**
>

분산 환경에서 트랜잭션을 보장하려면 **강한 일관성보다는 최종적 일관성을 유지하는 것이 현실적**.

- 2PC는 **강한 일관성이 필요할 때**,
- SAGA 패턴은 **분산 서비스에서 트랜잭션을 보장할 때**,
- Outbox & CDC는 **이벤트 기반 아키텍처를 적용할 때** 사용.
- **서비스 특성에 맞는 트랜잭션 관리 전략 선택 필요!**