## 분산락(Distributed Lock) 개념 및 적용 방법

[참고하면 좋을 자료 (DB, Redis Lock)](https://github.com/2dongyeop/concurrency-solution)

> **분산락이란?**
>

- **여러 노드(서버)에서 동시에 공유 자원(DB, Redis, 파일 등)에 접근할 때, 동시성 문제를 방지하는 기법**
- 하나의 서버가 락을 획득하면, **다른 서버는 동일한 자원에 접근할 수 없음**
- **사용 예시:**
    - **동일한 결제 요청이 동시에 들어왔을 때 중복 결제 방지**
    - **재고 감소 로직에서 중복 차감 방지**
    - **Cron Job이 여러 서버에서 실행되는 경우 하나의 서버에서만 실행되도록 제한**

<br/>

> **분산락을 구현하는 방법**
>

1. **DB 기반 분산락**
    - **방법:**
        - 특정 Row에 `SELECT ... FOR UPDATE` 로 락을 걸고, 트랜잭션이 끝날 때까지 다른 트랜잭션이 접근하지 못하게 함.
        - 또는 `LOCK TABLE`을 사용하여 테이블 단위로 락을 설정 가능.
    - **장점:**
        - 데이터 일관성이 높음 (DB 트랜잭션 기반)
        - Spring Boot에서 쉽게 적용 가능 (`@Transactional`)
    - **단점:**
        - 성능 저하 (DB에 락을 거는 방식이므로 높은 부하 발생)
        - 락 해제 문제 (비정상 종료 시 락이 풀리지 않을 수 있음)

1. **Redis 기반 분산락 (Redisson, SETNX 활용)**
    - **방법:**
        - `SETNX (SET if Not Exists)` 명령어를 활용하여 락을 설정
        - `EXPIRE`를 설정하여 락이 영구적으로 걸리는 문제 방지
    - **장점:**
        - 성능 우수 (DB보다 가벼움)
        - TTL 설정 가능 (비정상 종료 시 락 자동 해제)
    - **단점:**
        - Redis 장애 시 락 동기화 문제 발생 가능
        - 네트워크 지연으로 인해 락이 해제되기 전에 작업이 끝나지 않을 위험 있음

<br/>

> 분산락을 적용할 때 고려할 점
>

1. **락 해제 문제**
    - **애플리케이션이 비정상 종료되면 락이 해제되지 않는 문제** 발생 가능
    - → **Redis의 TTL(Time To Live) 설정으로 해결**
2. **성능 이슈**
    - **DB 기반 락**은 동시 요청이 많으면 DB 부하가 커짐
    - → **Redis 기반 락을 사용하여 성능 최적화**
3. **락 획득 실패 처리**
    - **락을 얻지 못한 요청을 재시도해야 하는 경우**
        - → **Retry 정책 적용 (Exponential Backoff)**
    - **락이 너무 오래 유지되면 Deadlock 가능성**
    - → **Timeout 설정 필수**